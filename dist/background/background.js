import{D as B}from"../assets/types.js";function d(e){const[o,r]=e.split(":").map(Number);return o*60+r}function A(e,o){const r=e.getDay(),t=e.getHours()*60+e.getMinutes();return o.some(a=>{if(a.day!==r)return!1;const n=d(a.start),s=d(a.end);return n<=s?t>=n&&t<s:t>=n||t<s})}function R(e,o){var a;const r=[];for(let n=0;n<8;n++){const s=new Date(e);s.setDate(e.getDate()+n);const L=s.getDay();o.filter(u=>u.day===L).forEach(u=>{const S=d(u.start),C=d(u.end),E=v=>{const f=new Date(s);return f.setHours(0,0,0,0),f.setMinutes(v),f};r.push(E(S)),r.push(E(C))})}return((a=r.map(n=>({c:n,t:n.getTime()})).filter(n=>n.t>e.getTime()).sort((n,s)=>n.t-s.t)[0])==null?void 0:a.c)??new Date(e.getTime()+24*60*60*1e3)}const g="settings",l="temporaryUnblocks",y="schedule-boundary",p="cleanup-unblocks",m="reroll-reset",w="rerollResetTime";function c(...e){console.log("[Productivity Blocker]",...e)}async function k(){const{[g]:e}=await chrome.storage.sync.get(g);return{...B,...e||{}}}function i(e){return e.replace(/^https?:\/\//,"").replace(/\/.*$/,"").replace(/^www\./,"").toLowerCase()}function U(e,o){try{const r=new URL(e),t=i(r.hostname);return o.some(a=>{const n=i(a);return t===n||t.endsWith("."+n)})}catch{return!1}}async function D(e){try{const{[l]:o}=await chrome.storage.local.get(l);if(!o||!Array.isArray(o))return!1;const r=i(e),t=Date.now();return o.some(a=>{const n=i(a.domain);return(n===r||r.endsWith("."+n))&&a.expiresAt>t})}catch{return!1}}async function h(){try{const{[l]:e}=await chrome.storage.local.get(l);if(!e||!Array.isArray(e))return[];const o=Date.now();return e.filter(r=>r.expiresAt>o)}catch{return[]}}async function _(){try{const e=await h();await chrome.storage.local.set({[l]:e}),c("Cleaned up expired unblocks. Active unblocks:",e.length)}catch(e){console.error("Error cleaning up unblocks:",e)}}async function M(e,o){try{const r=await h(),t=i(e),a=r.filter(n=>i(n.domain)!==t);a.push({domain:t,expiresAt:o}),await chrome.storage.local.set({[l]:a}),c("Added temporary unblock:",e,"expires at:",new Date(o).toISOString())}catch(r){console.error("Error adding temporary unblock:",r)}}async function T(e){if(!(!e||e.length===0))try{const o=await chrome.tabs.query({}),r=[];for(const t of o)t.url&&U(t.url,e)&&(await D(t.url)?c("Tab not closed - temporarily unblocked:",t.url):(r.push(t.id),c("Closing blocked tab:",t.url,"tabId:",t.id)));r.length>0&&(await chrome.tabs.remove(r),c("Closed",r.length,"blocked tab(s)"))}catch(o){console.error("Error closing blocked tabs:",o)}}async function O(e,o){c("setBlockingEnabled:",{enabled:e,hostsCount:o.length,hosts:o});try{e&&o.length?(await T(o),c("Tab closing enabled for hosts:",o)):c("Tab closing disabled")}catch(r){console.error("Error setting blocking state:",r),setTimeout(async()=>{try{e&&o.length?(await T(o),c("Retry successful: tab closing enabled")):c("Retry successful: tab closing disabled")}catch(t){console.error("Retry also failed:",t)}},100)}}async function b(){try{const e=await k(),o=new Date,r=e.enabled&&A(o,e.windows);c("updateBlockingAndAlarm:",{enabled:e.enabled,shouldBlock:r,blockedHosts:e.blockedHosts,windows:e.windows,currentTime:o.toISOString()}),await O(r,e.blockedHosts);const t=R(o,e.windows);await chrome.alarms.clear(y),await chrome.alarms.create(y,{when:t.getTime()}),c("Next boundary scheduled for:",new Date(t.getTime()).toISOString())}catch(e){console.error("Error updating blocking and alarm:",e)}}chrome.runtime.onInstalled.addListener(()=>{b(),chrome.alarms.create(p,{periodInMinutes:1})});chrome.runtime.onStartup.addListener(()=>{b(),chrome.alarms.create(p,{periodInMinutes:1})});chrome.alarms.onAlarm.addListener(async e=>{e.name===y?b():e.name===p?_():e.name===m&&(c("Reroll reset timer expired, showing popup"),await I(),await chrome.storage.local.remove(w),await chrome.storage.local.remove("cardGambleRerollState"))});chrome.storage.onChanged.addListener((e,o)=>{o==="sync"&&e[g]&&b()});chrome.tabs.onUpdated.addListener(async(e,o,r)=>{if(!(o.status!=="complete"||!r.url))try{const t=await k();if(t.enabled&&A(new Date,t.windows)&&t.blockedHosts.length>0&&U(r.url,t.blockedHosts))if(await D(r.url))c("Tab not closed - temporarily unblocked:",r.url);else{c("Blocked site detected in tab update:",r.url);try{await chrome.tabs.remove(e),c("Closed blocked tab:",r.url)}catch{c("Could not close tab (may already be closed):",r.url)}}}catch(t){console.error("Error in tab update listener:",t)}});async function x(e){await chrome.alarms.clear(m),await chrome.storage.local.set({[w]:e}),await chrome.alarms.create(m,{when:e}),c("Scheduled reroll reset for:",new Date(e).toISOString())}async function I(){try{const e=await chrome.tabs.query({}),o=await k();if(!o.blockedHosts||o.blockedHosts.length===0){c("No blocked hosts, skipping popup");return}for(const r of e)if(r.id&&r.url&&!r.url.startsWith("chrome://")&&!r.url.startsWith("chrome-extension://"))try{await chrome.scripting.executeScript({target:{tabId:r.id},files:["content/cardPopup.js"]}),await chrome.tabs.sendMessage(r.id,{action:"showCardPopup"})}catch(t){c("Could not inject script into tab:",r.url,t)}c("Card popup shown on all tabs")}catch(e){console.error("Error showing card popup:",e)}}async function K(){try{await chrome.storage.local.remove(l),c("Cleared all temporary unblocks")}catch(e){throw console.error("Error clearing temporary unblocks:",e),e}}async function H(e){try{const o=await h(),r=i(e),t=o.filter(a=>i(a.domain)!==r);await chrome.storage.local.set({[l]:t}),c("Removed temporary unblock:",e)}catch(o){throw console.error("Error removing temporary unblock:",o),o}}chrome.runtime.onMessage.addListener((e,o,r)=>{if(e.action==="temporaryUnblock")return M(e.domain,e.expiresAt).then(()=>{r({success:!0}),c("Temporary unblock added:",e.domain,"for",e.durationMinutes,"minutes")}).catch(t=>{console.error("Error handling temporary unblock:",t),r({success:!1,error:t.message})}),!0;if(e.action==="scheduleRerollReset")return x(e.resetTime).then(()=>{r({success:!0})}).catch(t=>{console.error("Error scheduling reroll reset:",t),r({success:!1,error:t.message})}),!0;if(e.action==="cancelRerollReset")return chrome.alarms.clear(m).then(()=>{chrome.storage.local.remove(w).then(()=>{r({success:!0}),c("Reroll reset alarm canceled")})}).catch(t=>{console.error("Error canceling reroll reset:",t),r({success:!1,error:t.message})}),!0;if(e.action==="clearTemporaryUnblocks")return K().then(()=>{r({success:!0})}).catch(t=>{console.error("Error clearing temporary unblocks:",t),r({success:!1,error:t.message})}),!0;if(e.action==="getActiveUnblocks")return h().then(t=>{r({success:!0,unblocks:t})}).catch(t=>{console.error("Error getting active unblocks:",t),r({success:!1,error:t.message})}),!0;if(e.action==="cancelTemporaryUnblock")return H(e.domain).then(()=>{r({success:!0})}).catch(t=>{console.error("Error canceling temporary unblock:",t),r({success:!1,error:t.message})}),!0});chrome.action.onClicked.addListener(async()=>{try{await chrome.runtime.openOptionsPage(),c("Opened options page")}catch(e){console.error("Error opening options page:",e)}});
//# sourceMappingURL=background.js.map
